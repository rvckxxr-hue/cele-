<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gra Celów Dziennych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .goal-input:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
        }
        .goal-input.completed {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .custom-checkbox {
            min-width: 1.5rem;
            min-height: 1.5rem;
            appearance: none;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        .custom-checkbox:checked {
            background-color: #4ade80; /* green-400 */
            border-color: #4ade80; /* green-400 */
        }
        .custom-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
        }
        .win-card {
            border-color: #4ade80; /* green-400 */
            background-color: #f0fdf4; /* green-50 */
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
        }
        .canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        /* Animacja dla rozwijania statystyk */
        #extended-stats.hidden {
            display: none;
        }
        #extended-stats {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 1;
        }
        #extended-stats.collapsing {
            max-height: 0;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loading-spinner" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
    </div>

    <div class="canvas-container">
        <canvas id="confetti-canvas"></canvas>
    </div>

    <div class="max-w-md mx-auto p-4 sm:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600">Gra Celów</h1>
            <p class="text-slate-500 mt-1">Skup się na dzisiejszym zwycięstwie!</p>
        </header>

        <!-- Sekcja Statystyk -->
        <section id="stats" class="mb-8">
            <!-- Widoczna statystyka dnia -->
            <div id="day-stat" class="bg-white p-4 rounded-xl shadow-sm border-2 border-transparent transition-all duration-300">
                <h3 class="font-semibold text-slate-500">Dzisiejszy postęp</h3>
                <p id="day-progress" class="text-2xl font-bold mt-1">0/5</p>
                <p id="day-status" class="text-sm font-medium text-slate-400 h-5"></p>
            </div>

            <!-- Przycisk do pokazywania/ukrywania statystyk -->
            <div class="text-center mt-4">
                 <button id="toggle-stats-btn" class="text-indigo-600 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors text-sm">
                    Pokaż statystyki tygodnia i miesiąca
                 </button>
            </div>

            <!-- Ukryte statystyki -->
            <div id="extended-stats" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 hidden">
                 <div id="week-stat" class="bg-white p-4 rounded-xl shadow-sm border-2 border-transparent transition-all duration-300">
                    <h3 class="font-semibold text-slate-500">Tydzień</h3>
                    <p id="week-progress" class="text-2xl font-bold mt-1">0/6</p>
                    <p id="week-status" class="text-sm font-medium text-slate-400 h-5"></p>
                </div>
                <div id="month-stat" class="bg-white p-4 rounded-xl shadow-sm border-2 border-transparent transition-all duration-300">
                    <h3 class="font-semibold text-slate-500">Miesiąc</h3>
                    <p id="month-progress" class="text-2xl font-bold mt-1">0/25</p>
                    <p id="month-status" class="text-sm font-medium text-slate-400 h-5"></p>
                </div>
            </div>
        </section>


        <!-- Sekcja Celów -->
        <main>
            <h2 class="text-xl font-semibold mb-3">Twoje cele na dziś:</h2>
            <div id="goals-container" class="space-y-3">
                <!-- Cele będą generowane przez JS -->
            </div>
        </main>
    </div>

    <script type="module">
        // Importy Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfiguracja i inicjalizacja Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let userDataUnsubscribe = null;
        let goalsData = null;

        const goalsContainer = document.getElementById('goals-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const toggleStatsBtn = document.getElementById('toggle-stats-btn');
        const extendedStats = document.getElementById('extended-stats');

        // --- Logika Confetti ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        const confettiColors = ['#6366f1', '#818cf8', '#a5b4fc', '#4ade80', '#86efac', '#facc15'];

        function resizeCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }

        function ConfettiParticle() {
            this.x = Math.random() * confettiCanvas.width;
            this.y = Math.random() * confettiCanvas.height - confettiCanvas.height;
            this.size = Math.random() * 5 + 2;
            this.speed = Math.random() * 3 + 1;
            this.color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
            this.rotation = Math.random() * 360;
            this.spin = Math.random() < 0.5 ? -1 : 1;
        }

        ConfettiParticle.prototype.update = function() {
            this.y += this.speed;
            this.rotation += this.spin * 5;
            if (this.y > confettiCanvas.height) {
                this.y = -20;
                this.x = Math.random() * confettiCanvas.width;
            }
        };

        ConfettiParticle.prototype.draw = function() {
            confettiCtx.save();
            confettiCtx.translate(this.x, this.y);
            confettiCtx.rotate(this.rotation * Math.PI / 180);
            confettiCtx.fillStyle = this.color;
            confettiCtx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
            confettiCtx.restore();
        };

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animateConfetti);
        }

        function triggerConfetti() {
            if (confettiParticles.length > 0) return;
            for (let i = 0; i < 150; i++) {
                confettiParticles.push(new ConfettiParticle());
            }
            setTimeout(() => {
                confettiParticles = [];
            }, 5000);
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        animateConfetti();

        // --- Logika Aplikacji ---
        
        // Przełączanie widoczności statystyk
        toggleStatsBtn.addEventListener('click', () => {
            const isHidden = extendedStats.classList.contains('hidden');
            if (isHidden) {
                extendedStats.classList.remove('hidden');
                extendedStats.classList.remove('collapsing');
                toggleStatsBtn.textContent = 'Ukryj statystyki';
            } else {
                extendedStats.classList.add('collapsing');
                toggleStatsBtn.textContent = 'Pokaż statystyki tygodnia i miesiąca';
                // Poczekaj na zakończenie animacji, zanim dodasz klasę 'hidden'
                setTimeout(() => {
                    extendedStats.classList.add('hidden');
                }, 500); // Czas musi pasować do transition w CSS
            }
        });

        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const createDefaultGoals = () => Array(5).fill({ text: '', completed: false });

        const renderGoals = (goals) => {
            goalsContainer.innerHTML = '';
            goals.forEach((goal, index) => {
                const goalEl = document.createElement('div');
                goalEl.className = 'flex items-center bg-white p-3 rounded-xl shadow-sm gap-4';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = goal.completed;
                checkbox.dataset.index = index;
                checkbox.className = 'custom-checkbox';
                checkbox.addEventListener('change', handleGoalCheck);

                const input = document.createElement('input');
                input.type = 'text';
                input.value = goal.text;
                input.placeholder = `Cel #${index + 1}`;
                input.dataset.index = index;
                input.className = 'w-full bg-transparent text-lg border-b-2 border-transparent focus:border-indigo-500 transition-colors goal-input';
                if (goal.completed) {
                    input.classList.add('completed');
                }
                input.addEventListener('blur', handleGoalChange);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                });

                goalEl.appendChild(checkbox);
                goalEl.appendChild(input);
                goalsContainer.appendChild(goalEl);
            });
        };
        
        const renderStats = (data) => {
            const { goals, wins = [] } = data;
            const today = new Date();

            const completedToday = goals.filter(g => g.completed).length;
            const dayWon = completedToday === 5;
            document.getElementById('day-progress').textContent = `${completedToday}/5`;
            const dayStatCard = document.getElementById('day-stat');
            const dayStatus = document.getElementById('day-status');
            if (dayWon) {
                dayStatCard.classList.add('win-card');
                dayStatus.textContent = 'Dzień Wygrany! 🎉';
            } else {
                dayStatCard.classList.remove('win-card');
                dayStatus.textContent = '';
            }

            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startOfWeek.setDate(today.getDate() - diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const winsThisWeek = wins.filter(winDate => new Date(winDate) >= startOfWeek).length;
            const weekWon = winsThisWeek >= 6;
            document.getElementById('week-progress').textContent = `${winsThisWeek}/6`;
            const weekStatCard = document.getElementById('week-stat');
            const weekStatus = document.getElementById('week-status');
            if (weekWon) {
                weekStatCard.classList.add('win-card');
                weekStatus.textContent = 'Tydzień Wygrany! 🏆';
            } else {
                weekStatCard.classList.remove('win-card');
                weekStatus.textContent = '';
            }

            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const winsThisMonth = wins.filter(winDate => new Date(winDate) >= startOfMonth).length;
            const monthWon = winsThisMonth >= 25;
            document.getElementById('month-progress').textContent = `${winsThisMonth}/25`;
            const monthStatCard = document.getElementById('month-stat');
            const monthStatus = document.getElementById('month-status');
            if (monthWon) {
                monthStatCard.classList.add('win-card');
                monthStatus.textContent = 'Miesiąc Wygrany! 🥇';
            } else {
                monthStatCard.classList.remove('win-card');
                monthStatus.textContent = '';
            }
        };

        const handleGoalChange = async (e) => {
            const index = parseInt(e.target.dataset.index, 10);
            const newText = e.target.value;
            if (!goalsData || goalsData.goals[index].text === newText) return;

            const updatedGoals = [...goalsData.goals];
            updatedGoals[index].text = newText;
            
            const docRef = doc(db, "artifacts", appId, "users", userId, "goalData", "singleton");
            await updateDoc(docRef, { goals: updatedGoals });
        };

        const handleGoalCheck = async (e) => {
            const index = parseInt(e.target.dataset.index, 10);
            const isChecked = e.target.checked;
            if (!goalsData || goalsData.goals[index].completed === isChecked) return;

            const updatedGoals = [...goalsData.goals];
            updatedGoals[index].completed = isChecked;

            const allCompleted = updatedGoals.every(g => g.completed);
            const todayStr = getTodayDateString();
            const newWins = goalsData.wins ? [...goalsData.wins] : [];
            const alreadyWonToday = newWins.includes(todayStr);

            const docRef = doc(db, "artifacts", appId, "users", userId, "goalData", "singleton");

            if (allCompleted && !alreadyWonToday) {
                newWins.push(todayStr);
                triggerConfetti();
                await updateDoc(docRef, { goals: updatedGoals, wins: newWins });
            } else {
                await updateDoc(docRef, { goals: updatedGoals });
            }
        };
        
        const initializeUserData = async () => {
            if (!userId) return;

            const docRef = doc(db, "artifacts", appId, "users", userId, "goalData", "singleton");
            
            if (userDataUnsubscribe) {
                userDataUnsubscribe();
            }

            userDataUnsubscribe = onSnapshot(docRef, async (docSnap) => {
                const todayStr = getTodayDateString();

                if (!docSnap.exists()) {
                    const initialData = {
                        lastUpdated: todayStr,
                        goals: createDefaultGoals(),
                        wins: []
                    };
                    await setDoc(docRef, initialData);
                    goalsData = initialData;
                } else {
                    goalsData = docSnap.data();
                    if (goalsData.lastUpdated !== todayStr) {
                        const updatedData = {
                            ...goalsData,
                            lastUpdated: todayStr,
                            goals: createDefaultGoals()
                        };
                        await setDoc(docRef, updatedData);
                        goalsData = updatedData;
                    }
                }
                
                renderGoals(goalsData.goals);
                renderStats(goalsData);
                loadingSpinner.style.display = 'none';
            }, (error) => {
                console.error("Błąd podczas nasłuchiwania danych:", error);
                loadingSpinner.textContent = "Wystąpił błąd ładowania danych.";
            });
        };

        // Główny proces autoryzacji
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                await initializeUserData();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Błąd logowania:", error);
                    loadingSpinner.textContent = "Błąd autoryzacji.";
                }
            }
        });
    </script>
</body>
</html>



